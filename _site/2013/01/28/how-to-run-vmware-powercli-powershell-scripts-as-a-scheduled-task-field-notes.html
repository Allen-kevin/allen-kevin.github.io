<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<title> How To: Run VMWare PowerCLI (PowerShell) Scripts as a Scheduled Task [Field Notes] </title>
	    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	    <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">
        
        <!-- Bootstrap core CSS -->
    	<link href="/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

		<div class="container">

			<div class="col-sm-3">
				<h1>SeanKilleen.com</h1>
				<img id="about" src="/img/logo.jpg" height="75px" width="75px" /><br />	

				<strong>navigation</strong><br />
				<a href="/">home</a> <br />
				
					<a class="about" href="https://github.com/SeanKilleen">github</a><br />
				
					<a class="about" href="mailto:SeanKilleen@gmail.com">Email</a><br />
				
				
				
				<div id="about">
					<strong>about</strong><br />
					Thoughts on life and bytes from a digital twenty-something.
				</div>
				
			</div>

			<div class="col-sm-8 col-offset-1">
				
				<h1>How To: Run VMWare PowerCLI (PowerShell) Scripts as a Scheduled Task [Field Notes]</h1>
<span class="time">28 Jan 2013</span>

<div class="content">
	<div class="post"><h3>Problem</h3>

<p>I need to create a scheduled task that runs a powershell script that takes actions against my VMWare environment.</p>

<p>For this article, we&#39;ll use the example of shutting down all VMs in a Non-Production folder when we&#39;re not scheduled to be at our desk (a real problem I&#39;d faced).</p>

<h3>Solution</h3>

<h4>Before you Begin</h4>

<p>This solution assumes that you&#39;ve already got PowerCLI configured and know your way around a little bit of PowerCLI/PowerShell.</p>

<h4>Step 1: Create a VMWare Credential Store in a File</h4>

<p>Firstly, your script will need login permissions to connect to a VI server. We can set this up ahead of time by  creating an encrypted credential store for your server.</p>

<ul>
<li>Open PowerCLI as an Administrator.</li>
<li>Run the following command:</li>
</ul>
<div class="highlight"><pre><code class="language-text" data-lang="text">New-VICredentialStoreItem -host &#39;yourhost.yourdomain.com&#39; -user &#39;yourusername&#39; -password &#39;yourpassword&#39; -file C:\Path\To\Store\TheFile\In.creds
</code></pre></div>
<p><strong>NOTES</strong>: When creating the credential store, you&#39;ll want to create it as the same user that will eventually need to access it. If you create the credential file as user X but run the Scheduled Task as user Y, your task will be unable to read the file. Also, you don&#39;t need to have a file extension, but I use &quot;creds&quot; just to make it clearer to me. Obviously, replace the host, username, password, and path with something that makes sense to you.</p>

<h4>Step 2: Create a Script that Uses the Credential Store</h4>

<p>Create a PowerShell Script Similar to the following:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">#Stop an error from occurring when a transcript is already stopped
$ErrorActionPreference=&quot;SilentlyContinue&quot;
Stop-Transcript | out-null

#Reset the error level before starting the transcript
$ErrorActionPreference=&quot;Continue&quot;
Start-Transcript -path C:\temp\Shutdown_NonProductionVMs.log -append

#Add the VMWare Snap-in
Add-PSSnapin -Name VMWare.VimAutomation.Core

#Get the Credentials
$creds = Get-VICredentialStoreItem -file  C:\temp\pscreds.creds

#Connect to the server using the credentials file
Connect-VIServer -Server $creds.host -User $creds.User -Password $creds.Password

#Get all VMs within the non-production VMs folder and then shut them down
#NOTE the -WhatIf tag, which will stop it from shutting down the VMs until we&#39;re sure the script is good.

Get-Folder -Name &quot;03. Non-Production VMs&quot; | Get-VM | Shutdown-VMGuest -WhatIf

#Clean Up
Disconnect-VIServer -Force -Confirm:$false
Remove-PSSnapin -Name VMWare.VimAutomation.Core
Stop-Transcript
</code></pre></div>
<h4>Step 3: Set up the Scheduled Task</h4>

<ul>
<li>Create a scheduled task in the task scheduler.</li>
<li>Run the task with the highest privileges.</li>
<li>In the action for the task, run the program/script <code>powershell.exe</code>. </li>
<li>For the arguments, use <code>&quot;c:\Path\To\YourScript.ps1&quot;</code> (with quotes in case of spaces -- good habit).</li>
</ul>

<p>Test your task manually several times. Make sure the log output looks right.</p>

<h4>Taking it Live: Removing the -WhatIf</h4>

<p>When the task is scheduled and you&#39;re satisfied it will run as you intended it, edit the script to remove the <code>-WhatIf</code> line. This means the Guest OSes will actually be shut down.</p>

<h4>Afterwards: Gotchas</h4>

<p>I gained some insights from this process, mostly by trial and error. I thought I should share the fruits of my errors with you:</p>

<ul>
<li>Do not run a powershell script directly as a scheduled task. It does not work. Use the <code>powershell.exe &quot;C:\Path\To\script.ps1&quot;</code> format to execute.</li>
</ul>

<h3>References</h3>

<ul>
<li><a href="http://powershellcommunity.org/Forums/tabid/54/aft/4295/Default.aspx" target="_blank">Scheduled Powershell scripts not passing authentication to Connect-VIServer</a> [<a href="http://powershellcommunity.org/" target="_blank">PowerShellCommunity.org</a>]</li>
<li><a href="http://professionalvmware.com/2009/04/posh-article-of-the-week-secure-credential-storage/" target="_blank">PoSH Article of the Week! â€“ Secure Credential Storage</a> [<a href="http://professionalvmware.com/" target="_blank">Professional VMWare</a>]</li>
<li><a href="http://stackoverflow.com/questions/14564732/powershell-vmware-script-not-running-from-scheduled-task" target="_blank">Powershell VMWare Script not running from Scheduled Task</a> [<a href="http://www.stackoverflow.com/" target="_blank">StackOverflow</a>]</li></ul></li>
</ul>
</div>
</div>

				
				<footer>
					&copy; SeanKilleen.com
					 
						- <a href="https://www.github.com/SeanKilleen">https://www.github.com/SeanKilleen</a>
					
				</footer>
			</div>
		
		</div>

	<!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    </body>
</html>
